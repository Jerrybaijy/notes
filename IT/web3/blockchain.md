# Blockchain

## 区块链

区块链（Blockchain）是一种分布式账本技术，用于安全、透明和不可篡改地记录交易数据。世界上第一个区块链是**比特币区块链**。

**区块链的核心特点**：

1. **去中心化**：区块链不依赖于中央机构，而是由网络中的多个节点共同维护。
2. **透明性**：所有参与者都可以查看区块链上的交易记录。
3. **安全性**：通过加密技术确保数据的安全和完整性。

## 区块链分类

### 按网络范围分类

| 类型 | 去中心化程度 | 性能 | 数据隐私性 | 典型应用场景 |
| :---: | :---: | :---: | :---: | :---: |
| 公有链 | 完全去中心化 | 低吞吐量 | 低 | 加密货币、DeFi |
| 联盟链 | 部分去中心化 | 高吞吐量 | 中等 | 跨机构协作、政务平台 |
| 私有链 | 中心化 | 极高吞吐量 | 高 | 企业内部管理 |

#### 公有链

**公有链**（Public Blockchain，简称**公链**）是一种完全开放、无需授权的区块链网络，任何人均可参与交易验证和数据读写。

**应用场景**：加密货币（如比特币）和 DeFi 等。

**关键特征**：

- **完全去中心化**：无单一控制机构，数据全网公开透明。
- **共识机制**：依赖工作量证明（PoW）、权益证明（PoS）等算法维护网络安全。
- **数据隐私性差**：数据全网公开。
- **匿名性强**：用户无需公开身份即可参与，无门槛限制。
- **性能瓶颈**：交易速度较慢（如比特币每秒处理约7笔交易），能耗较高。

#### 联盟链

**联盟链**（Consortium Blockchain）是由多个预选机构共同管理的区块链网络，参与节点需经授权。

**联盟链的应用场景**：跨机构数据共享（如政务平台、医疗数据互通）、企业合作项目等。

**私链的关键特征**：

- **部分去中心化**：治理权由联盟成员共享，数据仅在授权范围内可见。
- **高效与隐私平衡**：采用松散的共识机制（如PBFT），交易速度可达每秒10万笔。
- **可定制性**：支持灵活调整规则以适应行业需求（如供应链金融、电子取证）

#### 私有链

**私有链**（Private Blockchain，简称**私链**）是由单一组织内部使用的区块链网络，节点权限受严格控制。

**私链的应用场景**：企业内部审计、数据库管理、政务系统（如数字身份认证）等

**私链的关键特征**：

- **中心化**：数据读写权限集中于管理方，安全性依赖中心节点维护。
- **数据隐私性强**：数据仅对内部开放，适合敏感信息管理。
- **高性能**：交易速度快、成本低，适用于高频业务场景。

### 按部署环境分类

- **主链（Mainnet）**：正式运行的区块链网络（如以太坊主网）
- **测试链（Testnet）**：开发者用于实验的模拟环境（如比特币测试链）

### 按对接类型分类

- **单链**：独立运行的区块链系统（如比特币主链）
- **侧链（Sidechain）**：与主链互联的独立链，用于扩展功能（如 Liquid Network）
- **互联链（Interchain）**：实现跨链互操作的协议（如 Cosmos、Polkadot）

### 技术演进与趋势

- **混合链（Hybrid Chain）**：结合公有链与联盟链特性，平衡开放性与效率（如数字人民币底层技术）
- **跨链技术**：解决不同区块链间数据孤岛问题，推动多链生态互联（如跨链桥协议）

## 六层功能模型

- **数据层**：负责存储区块结构、Merkle 树、加密算法（如哈希函数、数字签名）等，确保数据的不可篡改性和完整性。
- **网络层**：管理节点间的 P2P 通信，包括数据传播、验证机制和网络拓扑结构。
- **共识层**：实现分布式节点间的账本一致性，核心机制包括 PoW、PoS、DPoS 等。
- **激励层**：通过经济模型激励节点参与网络维护，如比特币的区块奖励和以太坊的 Gas 费机制。
- **合约层**：支持智能合约和脚本代码，扩展区块链的可编程性（如以太坊的 Solidity 语言）。
- **应用层**：面向用户的 DApp 和工具（如钱包、交易所），直接服务于金融、游戏等场景。

## 标准区块链架构

- **基础层**：包含计算、存储和网络资源，提供区块链运行的物理环境（如云计算服务器或本地节点）。
- **平台层**：实现核心功能：智能合约执行环境、账本管理、共识算法、加密服务等。
- **API层**：为外部应用提供访问接口，支持区块链功能的调用和节点管理。
- **用户层**：用户交互入口，包括 DApp 界面和管理工具（如 MetaMask 钱包）。
- **外部交互层**：处理链外数据（预言机）与非原生应用的集成，例如 Chainlink 的数据喂送。

## 区块链分层架构

| 层级 | 定位 | 核心目标 | 典型技术 |
| :---: | :---: | :---: | :---: |
| L0 | 跨链基础设施 | 互操作性与开发效率 | Tendermint IBC、Substrate |
| L1 | 底层主链 | 去中心化与安全性 | PoW、PoS、智能合约 |
| L2 | 性能扩展方案 | 高吞吐量与低成本 | Rollups、侧链、状态通道 |

### L0

**Layer 0**（跨链协议层，简称 L0）是区块链的基础网络层，提供跨链通信、节点连接和底层协议支持。

**核心功能**：

- **跨链互操作**：允许不同区块链通过统一协议交互（如 Cosmos 的 IBC 协议）。

- **基础设施框架**：为 L1 提供开发模板（如 Polkadot 的 Substrate 框架）。

- **高效交易**：通过 PoS 等共识机制实现快速跨链交易。

**代表项目**：Cosmos、Polkadot、Avalanche

### L1

**Layer 1**（基础层，简称 L1）是独立的底层区块链，负责交易验证、共识机制与核心安全。

**核心功能**：

- **去中心化与安全性**：通过 PoW/PoS 等共识保障网络抗攻击性。

- **智能合约支持**：如以太坊的 Solidity 语言，支持 DApp 开发。

- **原生代币发行**：如比特币（BTC）、以太坊（ETH）。

**技术挑战**：区块链三难困境（去中心化、安全、扩展性难以兼得）

**代表项目**：比特币、以太坊、Solana

### L2

**Layer 2**（扩展层，简称 L2）是构建于 L1 之上的协议，通过链下处理提升性能。

**核心功能**：

- **扩容提速**：如 Optimistic Rollups（Arbitrum）和 ZK-Rollups（zkSync）。
- **降低成本**：减少主链资源占用，Gas 费降低 90% 以上。
- **灵活扩展**：支持侧链（Polygon）、状态通道（闪电网络）等方案。

**依赖关系**：安全性由 L1 保障，如以太坊 L2 需向主链提交最终状态。

**代表项目**：Polygon、Arbitrum、StarkNet

# 区块链的数据结构

区块链作为 Web3 生态的核心基础设施，相当于一个分布式数据库，用于存储全球范围内的交易数据、智能合约、用户身份信息和各种类型的去中心化应用（ dApps ）数据。

以太坊区块链从上往下可以依次分解为：区块链、区块、交易三个层次，其中的交易数据、收据数据、状态数据和账户数据都分别存储在四棵默克尔树中。

## **区块链**

区块链是一系列数据块（即“区块”），通过特定的方式相互连接，形成的一条链。每个区块都包含前一个区块的哈希值，称为“父哈希值”（ Parent Hash ），这是前一个区块内容的唯一标识符。通过这种方式，每个区块都与前一个区块相连接，形成了一条从第一个区块（创世区块）到最新区块的连续链条，这就是“区块链”。注：第一个区块里无父哈希值。

![image-20250426131538153](assets/image-20250426131538153.png)

## **区块**

区块链中的每一个区块，都由两个部分组成：区块头（ Header ）和区块体（ Body ）。

<img src="assets/image-20250426132329466.png" alt="image-20250426132329466" style="zoom:50%;" />

### 区块头

区块头里包含了一个区块的基本信息，主要包括：

- **父哈希值（ parentHash ）**：记录前一个区块的哈希值。
- **时间戳（ timestamp ）**：记录区块创建的具体时间。
- **随机数（ nonce ）**：用于工作量证明（ PoW ）机制中的挖矿过程。
- **难度目标（ difficulty ）**：表示挖矿的难度。
- **币基（ coinBase ）**：标识矿工的账户地址。

区块头里还记录了三个非常重要的根哈希值：

- **状态树根（ stateRoot ）**：表示了区块链的状态树的根哈希值，状态树记录了所有账户的状态信息，如余额、合约代码等。
- **收据树根（ receiptRoot ）**：表示收据树的根哈希值，收据树记录了交易执行的结果，如交易是否成功、交易费用等。
- **交易树根（ transactionRoot ）**：表示交易树的根哈希值，交易树包含了区块中所有交易的信息。

### 区块体

区块体里存储了该区块中的所有交易数据，即所有交易哈希的列表。

## 交易

在以太坊中，交易代表从一个账户向另一个账户发送资产或消息的行为。当用户发起一笔交易时，以太坊客户端或钱包软件将会构造交易数据。交易数据主要包含如下字段：

- **nonce** ：发送方账户的交易计数器，统计该账户在此区块链中的总交易次数。
- **gasPrice**：发送方愿意为每单位 gas 支付的价格。
- **gasLimit**：发送方为这次交易设置的最大 gas 消耗量。
- **to** ：接收方的账户地址。
- **value**：要传输的以太币数量。
- **data** ：智能合约相关的字节码。
- **V ， r ， S** ：交易签名，由发送方的私钥生成。

交易数据构造完成后，钱包将使用用户的私钥对整个交易进行签名，并将签名结果（ v, r, s ）加入交易数据中，然后对整个交易数据（不包括签名）计算哈希值，交易哈希是交易数据的唯一标识符，确保了交易的唯一性和不可篡改。

<img src="assets/image-20250426132914071.png" alt="image-20250426132914071" style="zoom:50%;" />

例如，Alice 想要发送 1 ETH 给 Bob，Alice 的账户地址是 0x123…ABC，Bob 的账户地址是 0x456…DEF。Alice 的账户已经执行过5笔交易，所以她的下一笔交易的 nonce 为6。当前的 gas 价格是 20 Gwei，她设置的 gas limit 是21000（标准以太坊转账所需的gas费）。Alice 不调用任何合约，所以 data 字段为空。

- nonce: 6
- gasPrice: 20000000000 （ 20 Gwei)
- gasLimit: 21000
- to: Ox456...DEF
- value: 1000000000000000000 （ 1 ETH)
- data: Ox
- v ， r ， s: [签名数据]

Alice 的钱包会把这些交易数据进行打包和签名，然后生成交易哈希，并将这个交易广播到以太坊网络。矿工将确认这笔交易并将其加入新区块，一旦成功，1 ETH 就会从 Alice 的账户转移到 Bob 的账户。

## 交易收据

